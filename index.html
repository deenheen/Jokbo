<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Med-Study OS v8.1 (Drawing Feature Added)</title>
    <style>
        /* [ê¸°ë³¸ ìŠ¤íƒ€ì¼ & í°íŠ¸] */
        @import url('https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css');
        * { box-sizing: border-box; margin: 0; padding: 0; font-family: 'Pretendard', sans-serif; }
        body { background-color: #f0f2f5; height: 100vh; display: flex; justify-content: center; align-items: center; overflow: hidden; user-select: none; }

        /* [ë©”ì¸ í”„ë ˆì„] */
        .tablet-frame {
            width: 1600px; height: 950px; background: white; border-radius: 12px;
            box-shadow: 0 20px 50px rgba(0,0,0,0.15); border: 1px solid #ddd; display: flex; overflow: hidden;
        }

        /* --- [ì™¼ìª½: PDF ë·°ì–´ & í•„ê¸° ì˜ì—­] --- */
        .left-panel {
            flex: 1.6; background-color: #3e3e3e; display: flex; flex-direction: column;
            border-right: 1px solid #333; position: relative;
        }
        
        .pdf-header {
            height: 48px; background: #2b2b2b; color: #e0e0e0; display: flex; align-items: center;
            padding: 0 20px; justify-content: space-between; font-size: 13px; font-weight: 500; border-bottom: 1px solid #1a1a1a; z-index: 10;
        }

        /* í•„ê¸° ëª¨ë“œ í† ê¸€ ë²„íŠ¼ */
        .edit-mode-btn {
            padding: 6px 10px; background: #444; border-radius: 6px; cursor: pointer; transition: 0.2s; display: flex; align-items: center; gap: 6px;
        }
        .edit-mode-btn:hover { background: #555; }
        .edit-mode-btn.active { background: #2196f3; color: white; }

        /* í•„ê¸° íˆ´ë°” */
        .drawing-toolbar {
            position: absolute; top: 58px; left: 50%; transform: translateX(-50%);
            background: white; padding: 8px 12px; border-radius: 30px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2); display: none; gap: 8px; z-index: 100;
        }
        .drawing-toolbar.visible { display: flex; animation: slideDown 0.2s ease-out; }
        @keyframes slideDown { from { opacity: 0; transform: translate(-50%, -10px); } to { opacity: 1; transform: translate(-50%, 0); } }

        .tool-btn {
            width: 36px; height: 36px; border-radius: 50%; border: 2px solid transparent;
            display: flex; justify-content: center; align-items: center; font-size: 18px; cursor: pointer; transition: 0.2s; color: #555; background: #f5f5f5;
        }
        .tool-btn:hover { background: #eee; }
        .tool-btn.active { border-color: #2196f3; color: #2196f3; background: #e3f2fd; }
        .tool-btn.undo-btn:active { transform: scale(0.9); background: #ddd; }

        .pdf-viewer-container {
            flex: 1; position: relative; overflow: hidden; background: #525659;
            display: flex; justify-content: center; align-items: center; padding: 20px;
        }

        /* ì‹¤ì œ PPT ìŠ¬ë¼ì´ë“œ ë° ìº”ë²„ìŠ¤ ë˜í¼ */
        .page-wrapper {
            width: 100%; height: 100%; max-width: 800px; max-height: 1130px;
            position: absolute; display: none; box-shadow: 0 4px 15px rgba(0,0,0,0.3);
        }
        .page-wrapper.active { display: block; animation: fadeIn 0.2s ease-out; }

        .pdf-page {
            width: 100%; height: 100%; background: white; padding: 40px 50px;
            position: absolute; top: 0; left: 0; display: flex; flex-direction: column; overflow-y: auto; z-index: 1;
        }
        /* í•„ê¸°ìš© ìº”ë²„ìŠ¤ - PDF ìœ„ì— ê²¹ì¹¨ */
        .drawing-canvas {
            position: absolute; top: 0; left: 0; z-index: 5; pointer-events: none; /* ê¸°ë³¸ì€ í´ë¦­ í†µê³¼ */
            touch-action: none; /* í„°ì¹˜ ìŠ¤í¬ë¡¤ ë°©ì§€ */
        }
        /* í¸ì§‘ ëª¨ë“œì¼ ë•Œë§Œ ìº”ë²„ìŠ¤ê°€ ì´ë²¤íŠ¸ë¥¼ ë°›ìŒ */
        .left-panel.drawing-mode .drawing-canvas { pointer-events: auto; cursor: crosshair; }
        /* í¸ì§‘ ëª¨ë“œì¼ ë•Œ ë“œë˜ê·¸ ì•¤ ë“œë¡­ ë°©ì§€ìš© ì»¤ë²„ */
        .left-panel.drawing-mode .pdf-page { pointer-events: none; }


        @keyframes fadeIn { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

        /* PDF ë‚´ë¶€ ë””ìì¸ (ê¸°ì¡´ ë™ì¼) */
        .slide-header { border-bottom: 2px solid #003c8f; padding-bottom: 10px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: flex-end; }
        .slide-title { font-size: 24px; font-weight: 800; color: #003c8f; }
        .slide-sub { font-size: 14px; color: #666; font-weight: 600; }
        
        .content-block { margin-bottom: 25px; }
        .section-title { font-size: 16px; font-weight: 700; color: #333; margin-bottom: 8px; display: flex; align-items: center; }
        .section-title::before { content: ""; display: inline-block; width: 4px; height: 16px; background: #1565c0; margin-right: 8px; }
        
        .text-body { font-size: 14px; line-height: 1.7; color: #444; text-align: justify; letter-spacing: -0.3px; }
        .text-body strong { color: #000; font-weight: 700; }
        .text-body ul { padding-left: 20px; margin-top: 5px; }
        .text-body li { margin-bottom: 4px; }

        /* ë„í‘œ ë° ë°•ìŠ¤ ìŠ¤íƒ€ì¼ (ê¸°ì¡´ ë™ì¼) */
        .info-box { background: #f5f9ff; border: 1px solid #b3e5fc; padding: 12px; border-radius: 6px; font-size: 13px; margin: 10px 0; color: #0277bd; }
        .warn-box { background: #fff5f5; border: 1px solid #ffcdd2; padding: 12px; border-radius: 6px; font-size: 13px; margin: 10px 0; color: #c62828; font-weight: 600; }
        .lab-table { width: 100%; border-collapse: collapse; font-size: 12px; margin: 10px 0; }
        .lab-table th { background: #eee; padding: 6px; border: 1px solid #ccc; text-align: center; }
        .lab-table td { padding: 6px; border: 1px solid #ccc; text-align: center; }

        /* ë„¤ë¹„ê²Œì´ì…˜ ë²„íŠ¼ */
        .nav-btn {
            position: absolute; top: 50%; transform: translateY(-50%);
            width: 44px; height: 44px; background: rgba(0,0,0,0.6); color: white;
            border-radius: 50%; display: flex; justify-content: center; align-items: center;
            cursor: pointer; font-size: 20px; z-index: 100; transition: 0.2s;
        }
        .nav-btn:hover { background: rgba(0,0,0,0.8); }
        .nav-prev { left: 20px; } .nav-next { right: 20px; }
        .nav-btn.disabled { opacity: 0; pointer-events: none; }

        /* ë“œë˜ê·¸ëœ ë©”ëª¨ (í¬ìŠ¤íŠ¸ì‡) */
        .dropped-note {
            position: absolute; width: 220px; background-color: #fff9c4; border-left: 4px solid #fbc02d;
            padding: 10px; font-size: 12px; color: #333; box-shadow: 2px 4px 10px rgba(0,0,0,0.2);
            border-radius: 0 6px 6px 0; cursor: pointer; z-index: 50; line-height: 1.4;
            font-family: 'Nanum Pen Script', sans-serif; pointer-events: auto; /* í•„ê¸° ëª¨ë“œì—ì„œë„ í´ë¦­ ê°€ëŠ¥í•˜ê²Œ */
        }
        .dropped-note:hover { transform: scale(1.05); z-index: 60; }
        .dropped-note strong { color: #e65100; }

        /* --- [ì˜¤ë¥¸ìª½: ê¸°ëŠ¥ íŒ¨ë„] (ê¸°ì¡´ ë™ì¼) --- */
        .right-panel {
            flex: 0.8; display: flex; flex-direction: column; background: #f7f8fa; border-left: 1px solid #ddd; position: relative;
        }
        
        /* íƒ­ ë©”ë‰´ */
        .tabs { display: flex; background: white; border-bottom: 1px solid #ddd; flex-shrink: 0; height: 50px; }
        .tab { flex: 1; display: flex; align-items: center; justify-content: center; cursor: pointer; font-weight: 600; color: #888; font-size: 14px; transition: 0.2s; }
        .tab:hover { background: #f9f9f9; }
        .tab.active { color: #2196f3; border-bottom: 3px solid #2196f3; background: #fff; }

        .tab-content-container { flex: 1; overflow-y: auto; position: relative; scroll-behavior: smooth; }
        .tab-content { display: none; padding: 20px; padding-bottom: 100px; }
        .tab-content.active { display: block; }

        /* 1. AI ì±„íŒ… (Real Chat) */
        .chat-container { display: flex; flex-direction: column; gap: 16px; }
        .msg-group { display: flex; flex-direction: column; gap: 6px; }
        .msg-meta { font-size: 11px; color: #999; margin-left: 4px; display: flex; gap: 6px; }
        
        .bubble { max-width: 92%; padding: 12px 16px; border-radius: 12px; font-size: 13.5px; line-height: 1.55; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .user-msg { align-self: flex-end; background: #4a90e2; color: white; border-bottom-right-radius: 2px; }
        .ai-msg { align-self: flex-start; background: white; color: #333; border: 1px solid #eee; border-bottom-left-radius: 2px; cursor: grab; }
        .ai-msg:hover { border-color: #2196f3; box-shadow: 0 2px 8px rgba(33, 150, 243, 0.15); }
        .ai-msg ul { padding-left: 18px; margin-top: 5px; }
        /* í•„ê¸° ëª¨ë“œì¼ ë•Œ ë“œë˜ê·¸ ë°©ì§€ */
        .left-panel.drawing-mode ~ .right-panel .ai-msg { cursor: default; pointer-events: none; opacity: 0.7; }


        /* 2. ì¡±ë³´ (KMLE Style) */
        .jokbo-card { background: white; padding: 20px; border-radius: 8px; border: 1px solid #e0e0e0; margin-bottom: 15px; display: none; box-shadow: 0 2px 5px rgba(0,0,0,0.02); }
        .jokbo-card.visible { display: block; animation: fadeIn 0.3s; }
        .badge-row { margin-bottom: 10px; }
        .badge { display: inline-block; padding: 3px 8px; font-size: 11px; border-radius: 4px; font-weight: 700; margin-right: 6px; }
        .badge.year { background: #e3f2fd; color: #1565c0; }
        .badge.tag { background: #f3e5f5; color: #7b1fa2; }
        .badge.freq { background: #ffebee; color: #c62828; }
        
        .q-body { font-size: 14px; font-weight: 600; color: #222; margin-bottom: 12px; line-height: 1.5; }
        .q-lab { font-size: 12px; color: #555; background: #f9f9f9; padding: 10px; border-radius: 6px; margin-bottom: 10px; font-family: monospace; border: 1px solid #eee; }
        .q-options { font-size: 13px; color: #444; display: flex; flex-direction: column; gap: 4px; }
        .q-options div { cursor: pointer; padding: 4px 8px; border-radius: 4px; }
        .q-options div:hover { background: #f0f0f0; }

        /* 3. ìŠ¤í¬ë¦½íŠ¸ (Transcript) */
        .script-segment { background: white; padding: 16px; border-radius: 8px; border: 1px solid #eee; margin-bottom: 12px; transition: all 0.3s; }
        .script-segment:hover { border-color: #b3e5fc; background: #fbfdff; }
        .script-header { display: flex; justify-content: space-between; margin-bottom: 6px; font-size: 11px; color: #888; }
        .speaker-name { font-weight: 700; color: #1976d2; }
        .script-text { font-size: 14px; line-height: 1.6; color: #333; }
        .highlight-text { background: linear-gradient(to top, #fff59d 50%, transparent 50%); }

        /* ì˜¤ë””ì˜¤ í”Œë ˆì´ì–´ */
        .audio-player-bar {
            position: absolute; bottom: 0; left: 0; right: 0; height: 80px; background: white; border-top: 1px solid #ddd;
            display: flex; align-items: center; padding: 0 25px; gap: 20px; box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
            display: none; z-index: 200;
        }
        .audio-player-bar.visible { display: flex; }
        .play-btn { width: 48px; height: 48px; background: #2196f3; border-radius: 50%; display: flex; justify-content: center; align-items: center; color: white; font-size: 20px; cursor: pointer; box-shadow: 0 4px 10px rgba(33, 150, 243, 0.4); transition: 0.2s; }
        .play-btn:hover { transform: scale(1.05); }
        .timeline-box { flex: 1; display: flex; flex-direction: column; gap: 8px; }
        .timeline-bg { height: 6px; background: #eee; border-radius: 3px; position: relative; overflow: hidden; cursor: pointer; }
        .timeline-fill { position: absolute; left: 0; top: 0; height: 100%; width: 0%; background: #2196f3; transition: width 0.2s linear; }
        .time-labels { display: flex; justify-content: space-between; font-size: 12px; color: #888; font-family: monospace; }
        
        /* ì‹±í¬ í•˜ì´ë¼ì´íŠ¸ íš¨ê³¼ */
        .active-context-bg { background-color: #fff9c4 !important; border-color: #fbc02d !important; box-shadow: 0 0 0 2px rgba(251, 192, 45, 0.3); }

    </style>
</head>
<body>

<div class="tablet-frame">
    <div class="left-panel" id="leftPanel">
        <div class="pdf-header">
            <div style="display: flex; align-items: center; gap: 10px;">
                <span>ğŸ“š Endocrinology_Ch04.pdf</span>
                <span id="headerPageNum" style="font-weight: normal; color: #999;">Page 13 / 60</span>
            </div>
            <div class="edit-mode-btn" onclick="toggleDrawingMode()">
                <span style="font-size: 16px;">âœï¸</span>
                <span style="font-size: 12px; font-weight: 600;">í•„ê¸° ëª¨ë“œ</span>
            </div>
        </div>

        <div class="drawing-toolbar" id="drawingToolbar">
            <div class="tool-btn active" onclick="setTool('pen', this)" title="íœ">ğŸ–Šï¸</div>
            <div class="tool-btn" onclick="setTool('highlighter', this)" title="í˜•ê´‘íœ" style="color: #FFD700;">ğŸ–ï¸</div>
            <div class="tool-btn" onclick="setTool('eraser', this)" title="ì§€ìš°ê°œ">ğŸ§½</div>
            <div style="width: 1px; height: 24px; background: #ddd; margin: 0 4px;"></div>
            <div class="tool-btn undo-btn" onclick="undoLastAction()" title="ë˜ëŒë¦¬ê¸°">â†©ï¸</div>
        </div>
        
        <div class="pdf-viewer-container">
            <div class="nav-btn nav-prev disabled" onclick="changePage(-1)">â®</div>
            <div class="nav-btn nav-next" onclick="changePage(1)">â¯</div>

            <div class="page-wrapper active" id="p13-wrapper">
                <div class="pdf-page" id="p13" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <div class="slide-header">
                        <div class="slide-title">Diabetic Ketoacidosis (DKA)</div>
                        <div class="slide-sub">Endocrinology Part.4</div>
                    </div>
                    <div class="content-block">
                        <div class="section-title">1. Definition & Epidemiology</div>
                        <p class="text-body">
                            ì¸ìŠë¦°ì˜ ì ˆëŒ€ì  ê²°í•(Absolute deficiency)ê³¼ ëŒ€í•­ í˜¸ë¥´ëª¬(Counter-regulatory hormones: Glucagon, Catecholamines, Cortisol, GH)ì˜ ì¦ê°€ë¡œ ì¸í•´ ë°œìƒí•˜ëŠ” ê¸‰ì„± ëŒ€ì‚¬ í•©ë³‘ì¦ì´ë‹¤.
                            <br>ì£¼ë¡œ ì œ1í˜• ë‹¹ë‡¨ë³‘(T1DM)ì—ì„œ ë°œìƒí•˜ë‚˜, ê·¹ì‹¬í•œ ìŠ¤íŠ¸ë ˆìŠ¤ ìƒí™©(ê°ì—¼, ì™¸ìƒ)ì—ì„œëŠ” ì œ2í˜• ë‹¹ë‡¨ë³‘(T2DM)ì—ì„œë„ ë°œìƒ ê°€ëŠ¥í•˜ë‹¤.
                        </p>
                    </div>
                    <div class="content-block">
                        <div class="section-title">2. Pathophysiology (ë³‘íƒœìƒë¦¬)</div>
                        <p class="text-body">
                            <strong>(1) Hyperglycemia (ê³ í˜ˆë‹¹):</strong> ê°„ì—ì„œì˜ í¬ë„ë‹¹ ìƒì„± ì¦ê°€(Gluconeogenesis) ë° ë§ì´ˆ ì¡°ì§ ì´ìš© ê°ì†Œ.<br>
                            <strong>(2) Ketosis (ì¼€í†¤ì¦):</strong> ì¸ìŠë¦° ë¶€ì¡± â†’ Lipolysis ì¦ê°€ â†’ Free Fatty Acid(FFA) ë°©ì¶œ â†’ ê°„ì—ì„œ Beta-oxidation â†’ Ketone bodies ìƒì„±.<br>
                        </p>
                        <div class="info-box">
                            <strong>ğŸ’¡ Key Mechanism:</strong><br>
                            Acetoacetate & Beta-hydroxybutyrate (Organic acids) accumulation <br>
                            â†’ High Anion Gap Metabolic Acidosis (HAGMA)
                        </div>
                    </div>
                    <div class="dropped-note" style="top:450px; left:450px;" onclick="focusChat('chat-13-1')">ğŸ“Œ AI ë©”ëª¨: ë³‘íƒœìƒë¦¬ í•µì‹¬ ìš”ì•½</div>
                </div>
                <canvas id="canvas-p13" class="drawing-canvas"></canvas>
            </div>

            <div class="page-wrapper" id="p14-wrapper">
                <div class="pdf-page" id="p14" ondrop="drop(event)" ondragover="allowDrop(event)">
                    <div class="slide-header">
                        <div class="slide-title">Precipitating Factors</div>
                        <div class="slide-sub">What triggers DKA?</div>
                    </div>
                    <div class="content-block">
                        <div class="section-title">Common Triggers (ìœ ë°œ ì¸ì)</div>
                        <p class="text-body">
                            <ul>
                                <li><strong>Infection (m/c, 30-40%):</strong> Pneumonia, UTI, Sepsis.</li>
                                <li><strong>Insulin Omission:</strong> í™˜ìì˜ ì„ì˜ íˆ¬ì—¬ ì¤‘ë‹¨, íŒí”„ ê³ ì¥.</li>
                                <li><strong>New Onset DM:</strong> ë‹¹ë‡¨ì¸ ì¤„ ëª°ëë˜ í™˜ìì˜ ì²« ì¦ìƒ (20-25%).</li>
                                <li>Acute Illness: MI, CVA, Pancreatitis, Trauma.</li>
                                <li>Drugs: Steroids, Thiazides, SGLT2 inhibitors (Euglycemic DKA).</li>
                            </ul>
                        </p>
                    </div>
                    <div class="warn-box">
                        <strong>âš ï¸ Clinical Pearl:</strong><br>
                        ê°ì—¼ ì§•í›„(ë°œì—´)ê°€ ì—†ë”ë¼ë„ ë°±í˜ˆêµ¬ ì¦ê°€(Leukocytosis)ëŠ” DKA ìì²´ë¡œ ë‚˜íƒ€ë‚  ìˆ˜ ìˆë‹¤. (Stress response)
                    </div>
                </div>
                <canvas id="canvas-p14" class="drawing-canvas"></canvas>
            </div>

            <div class="page-wrapper" id="p15-wrapper">
                <div class="pdf-page" id="p15" ondrop="drop(event)" ondragover="allowDrop(event)">
                     <div class="slide-header"><div class="slide-title">Clinical Features</div></div>
                     <p style="padding: 50px; color: #999; text-align: center;">(Page 15 ë‚´ìš©...)</p>
                </div>
                <canvas id="canvas-p15" class="drawing-canvas"></canvas>
            </div>
            <div class="page-wrapper" id="p16-wrapper">
                <div class="pdf-page" id="p16" ondrop="drop(event)" ondragover="allowDrop(event)">
                     <div class="slide-header"><div class="slide-title">Diagnosis & Lab Findings</div></div>
                     <p style="padding: 50px; color: #999; text-align: center;">(Page 16 ë‚´ìš©...)</p>
                </div>
                <canvas id="canvas-p16" class="drawing-canvas"></canvas>
            </div>


        </div>
    </div>

    <div class="right-panel">
        <div class="tabs">
            <div class="tab active" onclick="showTab('tab-chat')">AI ì±„íŒ…</div>
            <div class="tab" onclick="showTab('tab-jokbo')">ê´€ë ¨ ì¡±ë³´</div>
            <div class="tab" onclick="showTab('tab-script')">ë…¹ìŒ ìŠ¤í¬ë¦½íŠ¸</div>
        </div>

        <div class="tab-content-container">
            <div id="tab-chat" class="tab-content active">
                <div class="chat-container">
                    <div class="msg-group" id="chat-13-1">
                        <div class="msg-meta"><span>Page 13</span><span>â€¢</span><span>ë³‘íƒœìƒë¦¬</span></div>
                        <div class="bubble user-msg">DKAì˜ í•µì‹¬ ê¸°ì „ì´ ë­ì•¼?</div>
                        <div class="bubble ai-msg" draggable="true" ondragstart="drag(event)">
                            <strong>3ëŒ€ ìš”ì†Œ</strong>ê°€ í•µì‹¬ì…ë‹ˆë‹¤.<br>
                            1. ì¸ìŠë¦° ê²°í• (Insulin deficiency)<br>
                            2. ëŒ€í•­ í˜¸ë¥´ëª¬ ì¦ê°€ (Counter-regulatory hormones â†‘)<br>
                            ì´ë¡œ ì¸í•´ <strong>ì§€ë°© ë¶„í•´(Lipolysis)</strong>ê°€ ê°€ì†í™”ë˜ê³ , ê°„ì—ì„œ ì¼€í†¤ì²´ê°€ ìƒì„±ë˜ì–´ <strong>ëŒ€ì‚¬ì„± ì‚°ì¦</strong>ì´ ë°œìƒí•©ë‹ˆë‹¤.
                        </div>
                    </div>
                    </div>
            </div>
            <div id="tab-jokbo" class="tab-content">
                 <div class="jokbo-card p13-item visible">
                    <div class="q-body">Q. DKA ë°œìƒ ì‹œ ì¦ê°€í•˜ëŠ” í˜¸ë¥´ëª¬ì´ ì•„ë‹Œ ê²ƒì€?</div>
                 </div>
            </div>
            <div id="tab-script" class="tab-content">
                 </div>
        </div>

        <div class="audio-player-bar" id="audioPlayer">
            </div>
    </div>
</div>

<script>
    // [ì „ì—­ ë³€ìˆ˜ ì„¤ì •]
    const pages = ['p13', 'p14', 'p15', 'p16', 'p17', 'p18', 'p19', 'p20', 'p21', 'p22'];
    let currentPageIdx = 0;
    
    // í•„ê¸° ê´€ë ¨ ë³€ìˆ˜
    let isDrawingMode = false;
    let currentTool = 'pen'; // 'pen', 'highlighter', 'eraser'
    let isPainting = false;
    let currentCanvas, ctx;
    let lastX = 0, lastY = 0;
    
    // Undoë¥¼ ìœ„í•œ íˆìŠ¤í† ë¦¬ ì €ì¥ì†Œ (í˜ì´ì§€ë³„ë¡œ ê´€ë¦¬)
    const canvasHistory = {}; // { 'p13': [imageData1, imageData2, ...], ... }
    const maxHistoryStep = 20; // ìµœëŒ€ ì‹¤í–‰ ì·¨ì†Œ ë‹¨ê³„

    // [ì´ˆê¸°í™”]
    window.onload = function() {
        initCanvases();
        // ì´ˆê¸° í˜ì´ì§€ ë™ê¸°í™”
        syncRightPanel(pages[currentPageIdx].replace('p', ''));
    };

    // [ìº”ë²„ìŠ¤ ì´ˆê¸°í™” í•¨ìˆ˜]
    function initCanvases() {
        const wrappers = document.querySelectorAll('.page-wrapper');
        wrappers.forEach(wrapper => {
            const pageId = wrapper.id.replace('-wrapper', '');
            const canvas = document.getElementById(`canvas-${pageId}`);
            const pdfPage = document.getElementById(pageId);
            
            // ìº”ë²„ìŠ¤ í¬ê¸°ë¥¼ ì‹¤ì œ PDF í˜ì´ì§€ í¬ê¸°ì™€ ë§ì¶¤
            canvas.width = pdfPage.offsetWidth;
            canvas.height = pdfPage.offsetHeight;

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²°
            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);
            
            // í„°ì¹˜ ì§€ì›
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);

            // íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™”
            canvasHistory[pageId] = [];
        });
        updateCurrentCanvas(); // í˜„ì¬ í˜ì´ì§€ ìº”ë²„ìŠ¤ ì„¤ì •
    }

    // [í˜ì´ì§€ ë³€ê²½ ë¡œì§ (ìˆ˜ì •ë¨)]
    function changePage(direction) {
        const nextIdx = currentPageIdx + direction;
        if (nextIdx < 0 || nextIdx >= pages.length) return;

        // ì´ì „ í˜ì´ì§€ ìˆ¨ê¸°ê¸°
        document.getElementById(`${pages[currentPageIdx]}-wrapper`).classList.remove('active');
        
        // ìƒˆ í˜ì´ì§€ ë³´ì—¬ì£¼ê¸°
        currentPageIdx = nextIdx;
        const newPageId = pages[currentPageIdx];
        document.getElementById(`${newPageId}-wrapper`).classList.add('active');
        
        const pageNum = newPageId.replace('p', '');
        document.getElementById('headerPageNum').innerText = `Page ${pageNum} / 60`;
        
        document.querySelector('.nav-prev').classList.toggle('disabled', currentPageIdx === 0);
        document.querySelector('.nav-next').classList.toggle('disabled', currentPageIdx === pages.length - 1);

        updateCurrentCanvas(); // ìº”ë²„ìŠ¤ íƒ€ê²Ÿ ì—…ë°ì´íŠ¸
        syncRightPanel(pageNum);
    }

    // [í•„ê¸° ëª¨ë“œ í† ê¸€]
    function toggleDrawingMode() {
        isDrawingMode = !isDrawingMode;
        const leftPanel = document.getElementById('leftPanel');
        const toolbar = document.getElementById('drawingToolbar');
        const btn = document.querySelector('.edit-mode-btn');
        
        if (isDrawingMode) {
            leftPanel.classList.add('drawing-mode');
            toolbar.classList.add('visible');
            btn.classList.add('active');
            btn.querySelector('span:last-child').innerText = 'í•„ê¸° ì¢…ë£Œ';
        } else {
            leftPanel.classList.remove('drawing-mode');
            toolbar.classList.remove('visible');
            btn.classList.remove('active');
             btn.querySelector('span:last-child').innerText = 'í•„ê¸° ëª¨ë“œ';
        }
    }

    // [ë„êµ¬ ì„ íƒ]
    function setTool(tool, element) {
        currentTool = tool;
        document.querySelectorAll('.tool-btn').forEach(el => el.classList.remove('active'));
        element.classList.add('active');
    }

    // [í˜„ì¬ ìº”ë²„ìŠ¤ ì»¨í…ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸]
    function updateCurrentCanvas() {
        const pageId = pages[currentPageIdx];
        currentCanvas = document.getElementById(`canvas-${pageId}`);
        ctx = currentCanvas.getContext('2d', { willReadFrequently: true });
    }
    
    // [ê·¸ë¦¬ê¸° ì‹œì‘]
    function startDrawing(e) {
        if (!isDrawingMode) return;
        isPainting = true;
        [lastX, lastY] = getCoordinates(e);
        
        // ê·¸ë¦¬ê¸° ì§ì „ ìƒíƒœ ì €ì¥ (Undoìš©)
        saveHistory();

        // ì ë§Œ ì°ì—ˆì„ ë•Œë„ ê·¸ë ¤ì§€ë„ë¡
        draw(e);
    }

    // [ê·¸ë¦¬ê¸° ë™ì‘]
    function draw(e) {
        if (!isPainting || !isDrawingMode) return;
        
        const [x, y] = getCoordinates(e);
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(x, y);
        
        // ë„êµ¬ë³„ ìŠ¤íƒ€ì¼ ì„¤ì •
        if (currentTool === 'pen') {
            ctx.strokeStyle = '#222';
            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            ctx.globalCompositeOperation = 'source-over'; // ê¸°ë³¸ ë®ì–´ì“°ê¸°
        } else if (currentTool === 'highlighter') {
            ctx.strokeStyle = 'rgba(255, 235, 59, 0.4)'; // ë°˜íˆ¬ëª… ë…¸ë‘
            ctx.lineWidth = 20;
            ctx.lineCap = 'butt'; // í˜•ê´‘íœ ëŠë‚Œì„ ìœ„í•´ ëì„ ë­‰íˆ­í•˜ê²Œ
            ctx.lineJoin = 'round';
             ctx.globalCompositeOperation = 'source-over';
             // *ì°¸ê³ : ì‹¤ì œ í˜•ê´‘íœì²˜ëŸ¼ ê¸€ì”¨ ë’¤ë¡œ ê°€ê²Œ í•˜ë ¤ë©´ 'multiply' blend modeê°€ í•„ìš”í•˜ì§€ë§Œ, 
             // ë³„ë„ ìº”ë²„ìŠ¤ ë ˆì´ì–´ì—ì„œëŠ” êµ¬í˜„ì´ ë³µì¡í•´ ë°˜íˆ¬ëª… ì„ ìœ¼ë¡œ ëŒ€ì²´í•©ë‹ˆë‹¤.
        } else if (currentTool === 'eraser') {
            ctx.lineWidth = 30;
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            // ì§€ìš°ê°œ ëª¨ë“œ: ê·¸ë ¤ì§„ ë‚´ìš©ì„ íˆ¬ëª…í•˜ê²Œ ë§Œë“¦
            ctx.globalCompositeOperation = 'destination-out'; 
        }
        
        ctx.stroke();
        [lastX, lastY] = [x, y];
    }

    // [ê·¸ë¦¬ê¸° ì¢…ë£Œ]
    function stopDrawing() {
        if (isPainting) {
            isPainting = false;
            ctx.beginPath(); // ê²½ë¡œ ì´ˆê¸°í™”
        }
    }

    // [ì¢Œí‘œ ê³„ì‚°]
    function getCoordinates(e) {
        const rect = currentCanvas.getBoundingClientRect();
        const x = e.clientX || e.touches[0].clientX;
        const y = e.clientY || e.touches[0].clientY;
        return [x - rect.left, y - rect.top];
    }
    
    // [í„°ì¹˜ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬]
    function handleTouchStart(e) { e.preventDefault(); startDrawing(e); }
    function handleTouchMove(e) { e.preventDefault(); draw(e); }

    // [Undo ê¸°ëŠ¥: ìƒíƒœ ì €ì¥]
    function saveHistory() {
        const pageId = pages[currentPageIdx];
        const history = canvasHistory[pageId];
        // í˜„ì¬ ìº”ë²„ìŠ¤ ìƒíƒœë¥¼ ì´ë¯¸ì§€ ë°ì´í„°ë¡œ ì €ì¥
        history.push(ctx.getImageData(0, 0, currentCanvas.width, currentCanvas.height));
        // ìµœëŒ€ ë‹¨ê³„ ë„˜ìœ¼ë©´ ì˜¤ë˜ëœ ê²ƒ ì‚­ì œ
        if (history.length > maxHistoryStep) {
            history.shift();
        }
    }

    // [Undo ê¸°ëŠ¥: ì‹¤í–‰ ì·¨ì†Œ]
    function undoLastAction() {
        const pageId = pages[currentPageIdx];
        const history = canvasHistory[pageId];
        if (history.length > 0) {
            // ê°€ì¥ ìµœê·¼ ìƒíƒœë¥¼ êº¼ë‚´ì„œ ë‹¤ì‹œ ê·¸ë¦°ë‹¤
            const lastState = history.pop();
            ctx.putImageData(lastState, 0, 0);
        } else {
            // íˆìŠ¤í† ë¦¬ê°€ ë¹„ì—ˆìœ¼ë©´ ìº”ë²„ìŠ¤ë¥¼ ê¹¨ë—ì´ ì§€ìš´ë‹¤ (ì´ˆê¸° ìƒíƒœ)
            ctx.clearRect(0, 0, currentCanvas.width, currentCanvas.height);
        }
    }


    // --- [ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€] ---

    // [ì»¨í…ì¸  ë™ê¸°í™” ë§¤í•‘ (ê¸°ì¡´ ë™ì¼)]
    function syncRightPanel(pageNum) {
        document.querySelectorAll('.jokbo-card').forEach(card => card.classList.remove('visible'));
        document.querySelectorAll(`.p${pageNum}-item`).forEach(card => card.classList.add('visible'));

        const syncMap = {
            '13': { chat: 'chat-13-1', script: 'script-13-1', time: '09:30', progress: '10%' },
            '14': { chat: 'chat-14-1', script: 'script-13-1', time: '09:40', progress: '15%' },
            '15': { chat: 'chat-15-1', script: 'script-15-1', time: '09:45', progress: '25%' },
            '16': { chat: 'chat-16-1', script: 'script-15-1', time: '09:55', progress: '30%' },
            '17': { chat: 'chat-17-1', script: 'script-17-1', time: '10:10', progress: '40%' },
            '18': { chat: 'chat-18-1', script: 'script-18-1', time: '10:25', progress: '50%' },
            '19': { chat: 'chat-18-1', script: 'script-18-1', time: '10:30', progress: '55%' },
            '20': { chat: 'chat-18-1', script: 'script-20-1', time: '10:40', progress: '65%' },
            '21': { chat: 'chat-18-1', script: 'script-20-1', time: '10:50', progress: '75%' },
            '22': { chat: 'chat-18-1', script: 'script-22-1', time: '11:00', progress: '90%' }
        };

        const target = syncMap[pageNum];
        if (target) {
            const activeTabId = document.querySelector('.tab-content.active').id;
            let targetElId = null;
            if (activeTabId === 'tab-chat') targetElId = target.chat;
            else if (activeTabId === 'tab-script') targetElId = target.script;
            
            if (targetElId) {
                const targetEl = document.getElementById(targetElId);
                if (targetEl) {
                    const container = document.querySelector('.tab-content-container');
                    container.scrollTo({ top: targetEl.offsetTop - 20, behavior: 'smooth' });
                    highlightEffect(targetEl);
                }
            }
            const timeEl = document.getElementById('currentTime');
            const progEl = document.getElementById('audioProgress');
            if (timeEl && progEl) {
                timeEl.innerText = target.time;
                progEl.style.width = target.progress;
            }
        }
    }

    function highlightEffect(element) {
        document.querySelectorAll('.active-context-bg').forEach(el => el.classList.remove('active-context-bg'));
        element.classList.add('active-context-bg');
        setTimeout(() => { element.classList.remove('active-context-bg'); }, 2000);
    }

    // [íƒ­ ì „í™˜ (ê¸°ì¡´ ë™ì¼)]
    function showTab(tabId) {
        document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
        document.getElementById(tabId).classList.add('active');
        
        document.querySelectorAll('.tab').forEach(el => el.classList.remove('active'));
        const tabs = ['tab-chat', 'tab-jokbo', 'tab-script'];
        document.querySelectorAll('.tab')[tabs.indexOf(tabId)].classList.add('active');

        const player = document.getElementById('audioPlayer');
        if (player) {
            if (tabId === 'tab-script') player.classList.add('visible');
            else player.classList.remove('visible');
        }
        
        const currentPageNum = pages[currentPageIdx].replace('p', '');
        syncRightPanel(currentPageNum);
    }

    // [Drag & Drop (ìˆ˜ì •ë¨: í•„ê¸° ëª¨ë“œ ì•„ë‹ ë•Œë§Œ ë™ì‘)]
    function drag(ev) { 
        if (isDrawingMode) { ev.preventDefault(); return; } // í•„ê¸° ëª¨ë“œë©´ ë“œë˜ê·¸ ë§‰ìŒ
        ev.dataTransfer.setData("chatId", ev.target.id); ev.dataTransfer.setData("text", ev.target.innerText); 
    }
    function allowDrop(ev) { ev.preventDefault(); }
    function drop(ev) {
        ev.preventDefault();
        if (isDrawingMode) return; // í•„ê¸° ëª¨ë“œë©´ ë“œë¡­ ë¬´ì‹œ
        const chatId = ev.dataTransfer.getData("chatId"); 
        const tempDiv = document.createElement("div"); tempDiv.innerHTML = ev.dataTransfer.getData("text");
        const cleanText = tempDiv.textContent || tempDiv.innerText || "";
        const rect = ev.currentTarget.getBoundingClientRect();
        
        const note = document.createElement("div");
        note.className = "dropped-note"; 
        note.innerHTML = `ğŸ“Œ <strong>AI ë©”ëª¨</strong><br>${cleanText.substring(0, 30)}...`;
        // ì¢Œí‘œ ê³„ì‚° ë³´ì • (ìƒëŒ€ ìœ„ì¹˜)
        note.style.left = (ev.clientX - rect.left - 20) + "px"; 
        note.style.top = (ev.clientY - rect.top - 20) + "px";
        note.onclick = (e) => { e.stopPropagation(); focusChat(chatId); }; // ì´ë²¤íŠ¸ ë²„ë¸”ë§ ë°©ì§€
        
        ev.currentTarget.appendChild(note);
    }

    function focusChat(elementId) {
        showTab('tab-chat');
        const el = document.getElementById(elementId);
        if(el) {
            document.querySelector('.tab-content-container').scrollTo({ top: el.offsetTop - 80, behavior: 'smooth' });
            highlightEffect(el);
        }
    }
</script>
</body>
</html>
